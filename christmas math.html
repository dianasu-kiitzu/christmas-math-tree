<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÑ ËÅñË™ïÊï∏Â≠∏Ê®π - Âø´Ê®ÇÂ≠∏Êï∏Â≠∏</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #0f172a; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes bounce-short {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -60%) scale(1.1); }
        }
        .animate-bounce-short { animation: bounce-short 0.5s ease-in-out; }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icon Components (Inline SVGs to avoid dependencies) ---
        const Sparkles = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
        );
        const RefreshCw = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        );
        const Trophy = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M12 14.66V17"/><path d="M12 2v20"/><path d="M12 17a5 5 0 0 1-5-5V7h10v5a5 5 0 0 1-5 5Z"/></svg>
        );
        const Star = ({ size = 24, fill = "none", color = "currentColor", strokeWidth = 2, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        );
        const Wand2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></svg>
        );
        const X = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
        );

        // --- Main Component ---
        const MathTreeGame = () => {
            const [level, setLevel] = useState(1);
            const [problems, setProblems] = useState([]);
            const [answers, setAnswers] = useState([]);
            const [completed, setCompleted] = useState(false);
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });
            const [feedback, setFeedback] = useState(null);
            
            // AI Related State
            const [showAIModal, setShowAIModal] = useState(false);
            const [aiPrompt, setAiPrompt] = useState("Áµ¶Êàë 10 È°åÈÅ©ÂêàÂ∞èÂ≠∏‰∏ÄÂπ¥Á¥öÁöÑÂä†Ê∏õÊ≥ï");
            const [isGenerating, setIsGenerating] = useState(false);
            const [aiWinMessage, setAiWinMessage] = useState("");
            const [aiError, setAiError] = useState("");

            // Refs
            const treeRef = useRef(null);
            const slotRefs = useRef({});

            // ‚ö†Ô∏è Ë´ãÂú®ÈÄôË£°Â°´ÂÖ•ÊÇ®ÁöÑ Google Gemini API Key ÊâçËÉΩ‰ΩøÁî® AI ÂäüËÉΩ
            const apiKey = ""; 

            // Configuration
            const TREE_SLOTS_POS = [
                { id: 0, top: '22%', left: '50%' },
                { id: 1, top: '38%', left: '40%' },
                { id: 2, top: '38%', left: '60%' },
                { id: 3, top: '55%', left: '30%' },
                { id: 4, top: '55%', left: '50%' },
                { id: 5, top: '55%', left: '70%' },
                { id: 6, top: '72%', left: '20%' },
                { id: 7, top: '72%', left: '40%' },
                { id: 8, top: '72%', left: '60%' },
                { id: 9, top: '72%', left: '80%' },
            ];

            const BALL_STYLES = [
                { bg: 'from-red-400 to-red-600', border: 'border-red-300' },
                { bg: 'from-blue-400 to-blue-600', border: 'border-blue-300' },
                { bg: 'from-green-400 to-green-600', border: 'border-green-300' },
                { bg: 'from-purple-400 to-purple-600', border: 'border-purple-300' },
                { bg: 'from-orange-400 to-orange-600', border: 'border-orange-300' },
                { bg: 'from-pink-400 to-pink-600', border: 'border-pink-300' },
                { bg: 'from-teal-400 to-teal-600', border: 'border-teal-300' },
                { bg: 'from-indigo-400 to-indigo-600', border: 'border-indigo-300' },
                { bg: 'from-rose-400 to-rose-600', border: 'border-rose-300' },
                { bg: 'from-cyan-400 to-cyan-600', border: 'border-cyan-300' },
            ];

            useEffect(() => {
                startNewGame();
            }, [level]);

            // --- Gemini API Logic ---
            const callGemini = async (prompt, systemInstruction = "") => {
                if (!apiKey) {
                    alert("Ë´ãÂÖàÂú®Á®ãÂºèÁ¢º‰∏≠Ë®≠ÂÆöÊÇ®ÁöÑ Google API Key ÊâçËÉΩ‰ΩøÁî® AI ÂäüËÉΩÔºÅ");
                    throw new Error("No API Key");
                }
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                systemInstruction: { parts: [{ text: systemInstruction }] },
                                generationConfig: { responseMimeType: "application/json" }
                            }),
                        }
                    );
                    
                    if (!response.ok) throw new Error('API request failed');
                    const data = await response.json();
                    return JSON.parse(data.candidates[0].content.parts[0].text);
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    throw error;
                }
            };

            const generateAILevel = async () => {
                if (!aiPrompt.trim()) return;
                
                setIsGenerating(true);
                setAiError("");
                
                const systemPrompt = `
                  You are a math teacher creating a game for kids. 
                  Generate exactly 10 unique math problems based on the user's request.
                  The problems should be simple equations (e.g., "5 + 3").
                  
                  Requirements:
                  1. Return a JSON object with a property "problems" which is an array of 10 objects.
                  2. Each object must have:
                     - "num1" (number or string)
                     - "operator" (string: "+", "-", "x", "√∑")
                     - "num2" (number or string)
                     - "answer" (number)
                  3. CRITICAL: All 10 'answer' values MUST be unique (different from each other). This is a game mechanic requirement.
                  4. Ensure the difficulty matches the user's request.
                `;

                try {
                    const result = await callGemini(aiPrompt, systemPrompt);
                    
                    if (result && result.problems && result.problems.length > 0) {
                        setupGameFromData(result.problems.slice(0, 10));
                        setShowAIModal(false);
                    } else {
                        setAiError("AI ÁÑ°Ê≥ïÁîüÊàêÈ°åÁõÆÔºåË´ãÊèõÂÄãË™™Ê≥ïË©¶Ë©¶ÁúãÔºÅ");
                    }
                } catch (e) {
                    if (e.message !== "No API Key") {
                        setAiError("ÈÄ£Á∑öÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ");
                    }
                } finally {
                    setIsGenerating(false);
                }
            };

            const fetchAIWinMessage = async () => {
                if (!apiKey) {
                    setAiWinMessage("Â§™Ê£í‰∫ÜÔºÅ‰Ω†ÊòØÊï∏Â≠∏Â∞èÂ§©ÊâçÔºÅüéâ");
                    return;
                }
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: "Write a short, funny, emoji-filled congratulatory message for a kid who just solved 10 math problems. Keep it under 20 words. Traditional Chinese." }] }],
                            }),
                        }
                    );
                    const data = await response.json();
                    const msg = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (msg) setAiWinMessage(msg);
                } catch (e) {
                    setAiWinMessage("Â§™Ê£í‰∫ÜÔºÅ‰Ω†ÊòØÊï∏Â≠∏Â∞èÂ§©ÊâçÔºÅüéâ");
                }
            };

            // --- Game Logic ---
            const setupGameFromData = (dataList) => {
                const newProblems = [];
                const newAnswers = [];
                const shuffledColors = [...BALL_STYLES].sort(() => 0.5 - Math.random());

                dataList.forEach((item, i) => {
                    if (i >= 10) return; 
                    const questionStr = `${item.num1} ${item.operator} ${item.num2}`;
                    
                    newProblems.push({
                        id: i,
                        question: questionStr,
                        answer: item.answer,
                        solved: false,
                        ...TREE_SLOTS_POS[i]
                    });

                    const colorStyle = shuffledColors[i % shuffledColors.length];

                    newAnswers.push({
                        id: `ans-${i}`,
                        value: item.answer,
                        problemId: i,
                        currentSlot: null,
                        isDragging: false,
                        side: i % 2 === 0 ? 'left' : 'right',
                        colorStyle: colorStyle,
                    });
                });

                setProblems(newProblems);
                setAnswers(newAnswers);
                setCompleted(false);
                setFeedback(null);
                setAiWinMessage("");
            };

            const startNewGame = () => {
                const newProblems = [];
                const newAnswers = [];
                const count = 10;
                const usedAnswers = new Set();
                const shuffledColors = [...BALL_STYLES].sort(() => 0.5 - Math.random());

                for (let i = 0; i < count; i++) {
                    let num1, num2, operator, answer, questionStr;
                    do {
                        operator = Math.random() > 0.5 ? '+' : '-';
                        if (operator === '+') {
                            num1 = Math.floor(Math.random() * 10) + 1; 
                            num2 = Math.floor(Math.random() * 10) + 1;
                            answer = num1 + num2;
                        } else {
                            num1 = Math.floor(Math.random() * 15) + 5;
                            num2 = Math.floor(Math.random() * (num1 - 1)) + 1;
                            answer = num1 - num2;
                        }
                    } while (usedAnswers.has(answer));

                    usedAnswers.add(answer);
                    questionStr = `${num1} ${operator} ${num2}`;

                    newProblems.push({
                        id: i,
                        question: questionStr,
                        answer: answer,
                        solved: false,
                        ...TREE_SLOTS_POS[i]
                    });

                    const colorStyle = shuffledColors[i % shuffledColors.length];

                    newAnswers.push({
                        id: `ans-${i}`,
                        value: answer,
                        problemId: i,
                        currentSlot: null,
                        isDragging: false,
                        side: i % 2 === 0 ? 'left' : 'right',
                        colorStyle: colorStyle,
                    });
                }

                setProblems(newProblems);
                setAnswers(newAnswers);
                setCompleted(false);
                setFeedback(null);
                setAiWinMessage("");
            };

            // --- Drag and Drop Logic ---
            const handlePointerDown = (e, answerId) => {
                e.preventDefault(); 
                const answer = answers.find(a => a.id === answerId);
                if (answer.currentSlot !== null) return;

                setDraggedItem(answerId);
                setDragPosition({ x: e.clientX, y: e.clientY });
                setAnswers(prev => prev.map(a => a.id === answerId ? { ...a, isDragging: true } : a));
            };

            const handlePointerMove = (e) => {
                if (draggedItem) {
                    e.preventDefault();
                    setDragPosition({ x: e.clientX, y: e.clientY });
                }
            };

            const handlePointerUp = (e) => {
                if (!draggedItem) return;

                const droppedX = e.clientX;
                const droppedY = e.clientY;
                let targetSlotId = null;

                Object.keys(slotRefs.current).forEach((key) => {
                    const slotEl = slotRefs.current[key];
                    if (slotEl) {
                        const rect = slotEl.getBoundingClientRect();
                        const distance = Math.hypot(
                            rect.x + rect.width / 2 - droppedX,
                            rect.y + rect.height / 2 - droppedY
                        );
                        if (distance < 50) targetSlotId = parseInt(key);
                    }
                });

                if (targetSlotId !== null) {
                    checkAnswer(draggedItem, targetSlotId);
                } else {
                    resetDrag(draggedItem);
                }
                setDraggedItem(null);
            };

            const resetDrag = (id) => {
                setAnswers(prev => prev.map(a => a.id === id ? { ...a, isDragging: false } : a));
            };

            const checkAnswer = (ansId, slotId) => {
                const answerObj = answers.find(a => a.id === ansId);
                const problemObj = problems.find(p => p.id === slotId);

                if (problemObj.solved) {
                    resetDrag(ansId);
                    return;
                }

                if (answerObj.value === problemObj.answer) {
                    playSound('success');
                    setAnswers(prev => prev.map(a => 
                        a.id === ansId ? { ...a, isDragging: false, currentSlot: slotId } : a
                    ));
                    setProblems(prev => prev.map(p => 
                        p.id === slotId ? { ...p, solved: true } : p
                    ));
                    setFeedback('correct');
                    setTimeout(() => setFeedback(null), 1000);
                } else {
                    playSound('error');
                    setFeedback('wrong');
                    setTimeout(() => setFeedback(null), 1000);
                    resetDrag(ansId);
                }
            };

            useEffect(() => {
                if (problems.length > 0 && problems.every(p => p.solved)) {
                    setCompleted(true);
                    playSound('win');
                    fetchAIWinMessage();
                }
            }, [problems]);

            const playSound = (type) => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);

                if (type === 'success') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(500, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.3);
                } else if (type === 'error') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(200, ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.2);
                } else if (type === 'win') {
                    const now = ctx.currentTime;
                    [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                        const osc2 = ctx.createOscillator();
                        const gain2 = ctx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(ctx.destination);
                        osc2.type = 'triangle';
                        osc2.frequency.value = freq;
                        gain2.gain.setValueAtTime(0.1, now + i * 0.1);
                        gain2.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.5);
                        osc2.start(now + i * 0.1);
                        osc2.stop(now + i * 0.1 + 0.5);
                    });
                }
            };

            const getPlacedStyle = (ans) => {
                if (ans.currentSlot !== null) {
                    const slot = problems.find(p => p.id === ans.currentSlot);
                    return {
                        position: 'absolute',
                        left: slot.left,
                        top: slot.top,
                        transform: 'translate(-50%, -50%)',
                        zIndex: 10,
                        transition: 'all 0.3s ease-out'
                    };
                }
                return {};
            };

            return (
                <div 
                    className="w-full h-screen bg-slate-900 overflow-hidden flex flex-col items-center select-none touch-none"
                    onPointerMove={handlePointerMove}
                    onPointerUp={handlePointerUp}
                    style={{ touchAction: 'none' }} 
                >
                    {/* Background Snow Effect */}
                    <div className="absolute inset-0 pointer-events-none opacity-20">
                        {[...Array(20)].map((_, i) => (
                            <div 
                                key={i}
                                className="absolute bg-white rounded-full animate-pulse"
                                style={{
                                    width: Math.random() * 5 + 2 + 'px',
                                    height: Math.random() * 5 + 2 + 'px',
                                    top: Math.random() * 100 + '%',
                                    left: Math.random() * 100 + '%',
                                    animationDuration: Math.random() * 3 + 2 + 's'
                                }}
                            />
                        ))}
                    </div>

                    {/* Header */}
                    <div className="z-10 w-full p-4 flex justify-between items-center bg-slate-800/80 text-white shadow-lg border-b border-white/10">
                        <h1 className="text-xl md:text-2xl font-bold flex items-center gap-2 text-green-400">
                            <span className="text-2xl">üéÑ</span> ËÅñË™ïÊï∏Â≠∏Ê®π
                        </h1>
                        <div className="flex gap-2 md:gap-4">
                            <button 
                                onClick={() => setShowAIModal(true)}
                                className="flex items-center gap-2 px-3 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-full font-bold shadow-md transition-transform active:scale-95 text-sm md:text-base"
                            >
                                <Wand2 size={18} /> <span className="hidden md:inline">AI </span>Ëá™Ë®ÇÈóúÂç°
                            </button>
                            <button 
                                onClick={startNewGame}
                                className="flex items-center gap-2 px-3 py-2 bg-red-600 hover:bg-red-500 rounded-full font-bold shadow-md transition-transform active:scale-95 text-sm md:text-base"
                            >
                                <RefreshCw size={18} /> ÈáçÁé©
                            </button>
                        </div>
                    </div>

                    {/* Main Game Area */}
                    <div className="flex-1 w-full max-w-6xl flex relative overflow-hidden">
                        
                        {/* Left Side Answers */}
                        <div className="w-1/4 h-full flex flex-col items-center justify-center gap-4 py-4 z-20">
                            <div className="flex flex-col gap-3 w-full items-center overflow-y-auto hide-scrollbar pb-20">
                                {answers.filter(a => a.side === 'left').map(ans => {
                                    const isBeingDragged = ans.id === draggedItem;
                                    return (
                                        !ans.currentSlot && (
                                            <div
                                                key={ans.id}
                                                onPointerDown={(e) => handlePointerDown(e, ans.id)}
                                                style={{ 
                                                    opacity: isBeingDragged ? 0 : 1,
                                                    touchAction: 'none'
                                                }}
                                                className={`
                                                    w-12 h-12 md:w-16 md:h-16 rounded-full flex items-center justify-center 
                                                    text-xl md:text-2xl font-bold shadow-[0_4px_0_rgb(0,0,0,0.2)] cursor-grab
                                                    bg-gradient-to-br ${ans.colorStyle.bg} text-white border-2 ${ans.colorStyle.border}
                                                    transition-opacity duration-200
                                                `}
                                            >
                                                {ans.value}
                                                <div className="absolute -top-1 w-1 h-3 bg-yellow-600/50 rounded-full"></div>
                                            </div>
                                        )
                                    )
                                })}
                            </div>
                        </div>

                        {/* Center Tree */}
                        <div className="w-2/4 h-full relative flex items-center justify-center" ref={treeRef}>
                            <div className="relative w-full h-full max-h-[80vh] aspect-[2/3] flex items-center justify-center">
                                {/* Star */}
                                <div className={`absolute top-[8%] left-1/2 -translate-x-1/2 z-10 transition-all duration-500 ${completed ? 'scale-150 drop-shadow-[0_0_20px_rgba(255,255,0,0.8)]' : 'scale-100'}`}>
                                    <Star size={48} fill={completed ? "gold" : "#fbbf24"} color="#b45309" strokeWidth={2} className="animate-pulse" />
                                </div>

                                {/* Tree SVG */}
                                <svg viewBox="0 0 200 300" className="w-full h-full drop-shadow-2xl">
                                    <path d="M100 20 L 10 250 L 190 250 Z" fill="#15803d" stroke="#14532d" strokeWidth="3" />
                                    <path d="M30 200 Q 100 220 170 200" fill="none" stroke="#fbbf24" strokeWidth="2" strokeDasharray="5,5" opacity="0.6"/>
                                    <path d="M55 140 Q 100 160 145 140" fill="none" stroke="#fbbf24" strokeWidth="2" strokeDasharray="5,5" opacity="0.6"/>
                                    <path d="M75 80 Q 100 90 125 80" fill="none" stroke="#fbbf24" strokeWidth="2" strokeDasharray="5,5" opacity="0.6"/>
                                    <rect x="85" y="250" width="30" height="40" fill="#78350f" />
                                </svg>

                                {/* Problem Slots */}
                                {problems.map(prob => (
                                    <div
                                        key={prob.id}
                                        ref={el => slotRefs.current[prob.id] = el}
                                        className={`
                                            absolute w-14 h-14 md:w-20 md:h-20 rounded-full 
                                            flex items-center justify-center text-center
                                            transform -translate-x-1/2 -translate-y-1/2
                                            border-4 transition-all duration-300
                                            ${prob.solved 
                                                ? 'bg-yellow-100 border-yellow-400 shadow-[0_0_15px_rgba(255,215,0,0.6)]' 
                                                : 'bg-green-800/80 border-green-600 shadow-inner'
                                            }
                                        `}
                                        style={{ top: prob.top, left: prob.left }}
                                    >
                                        {!prob.solved && (
                                            <span className="text-white font-bold text-sm md:text-lg drop-shadow-md">
                                                {prob.question}
                                            </span>
                                        )}
                                    </div>
                                ))}

                                {/* Placed Answers */}
                                {answers.map(ans => (
                                    ans.currentSlot !== null && (
                                        <div
                                            key={ans.id}
                                            style={getPlacedStyle(ans)}
                                            className={`
                                                w-12 h-12 md:w-16 md:h-16 rounded-full flex items-center justify-center 
                                                text-xl md:text-2xl font-bold shadow-lg
                                                bg-gradient-to-br ${ans.colorStyle.bg} text-white border-2 ${ans.colorStyle.border}
                                                animate-bounce-short
                                            `}
                                        >
                                            {ans.value}
                                        </div>
                                    )
                                ))}
                            </div>
                        </div>

                        {/* Right Side Answers */}
                        <div className="w-1/4 h-full flex flex-col items-center justify-center gap-4 py-4 z-20">
                            <div className="flex flex-col gap-3 w-full items-center overflow-y-auto hide-scrollbar pb-20">
                                {answers.filter(a => a.side === 'right').map(ans => {
                                    const isBeingDragged = ans.id === draggedItem;
                                    return (
                                        !ans.currentSlot && (
                                            <div
                                                key={ans.id}
                                                onPointerDown={(e) => handlePointerDown(e, ans.id)}
                                                style={{ 
                                                    opacity: isBeingDragged ? 0 : 1,
                                                    touchAction: 'none' 
                                                }}
                                                className={`
                                                    w-12 h-12 md:w-16 md:h-16 rounded-full flex items-center justify-center 
                                                    text-xl md:text-2xl font-bold shadow-[0_4px_0_rgb(0,0,0,0.2)] cursor-grab
                                                    bg-gradient-to-br ${ans.colorStyle.bg} text-white border-2 ${ans.colorStyle.border}
                                                    transition-opacity duration-200
                                                `}
                                            >
                                                {ans.value}
                                                <div className="absolute -top-1 w-1 h-3 bg-yellow-600/50 rounded-full"></div>
                                            </div>
                                        )
                                    )
                                })}
                            </div>
                        </div>

                        {/* Dragging Item Portal */}
                        {draggedItem && (
                            <div 
                                style={{
                                    position: 'fixed',
                                    left: dragPosition.x,
                                    top: dragPosition.y,
                                    transform: 'translate(-50%, -50%) scale(1.2)',
                                    zIndex: 50,
                                    pointerEvents: 'none',
                                }}
                                className="
                                    w-16 h-16 rounded-full flex items-center justify-center 
                                    text-2xl font-bold shadow-2xl
                                    bg-yellow-400 text-yellow-900 ring-4 ring-white
                                "
                            >
                                {answers.find(a => a.id === draggedItem)?.value}
                            </div>
                        )}

                    </div>

                    {/* AI Level Generation Modal */}
                    {showAIModal && (
                        <div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-md">
                            <div className="bg-slate-800 rounded-2xl w-full max-w-lg p-6 border border-indigo-500 shadow-2xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-indigo-400 flex items-center gap-2">
                                        <Wand2 /> AI È≠îÊ≥ïÂá∫È°å
                                    </h2>
                                    <button onClick={() => setShowAIModal(false)} className="text-slate-400 hover:text-white">
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                <p className="text-slate-300 mb-4 text-sm">
                                    ÂëäË®¥ AI ËÄÅÂ∏´‰Ω†ÊÉ≥Á∑¥Áøí‰ªÄÈ∫ºÔºü‰æãÂ¶ÇÔºö„Äå99‰πòÊ≥ïË°®„Äç„ÄÅ„ÄåÁµêÊûúÂ§ßÊñº50ÁöÑÂä†Ê≥ï„Äç„ÄÅ„ÄåÂõ∞Èõ£ÁöÑÊ∏õÊ≥ï„Äç„ÄÇ
                                </p>

                                <textarea 
                                    value={aiPrompt}
                                    onChange={(e) => setAiPrompt(e.target.value)}
                                    className="w-full h-32 bg-slate-900 border border-slate-700 rounded-lg p-4 text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 mb-4"
                                    placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑÂá∫È°åË¶ÅÊ±Ç..."
                                />

                                {aiError && (
                                    <div className="text-red-400 text-sm mb-4 text-center">{aiError}</div>
                                )}

                                <button 
                                    onClick={generateAILevel}
                                    disabled={isGenerating}
                                    className={`w-full py-3 rounded-lg font-bold text-white transition-all
                                        ${isGenerating ? 'bg-slate-600 cursor-wait' : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:scale-[1.02]'}
                                    `}
                                >
                                    {isGenerating ? (
                                        <span className="flex items-center justify-center gap-2">
                                            <span className="animate-spin">‚è≥</span> Ê≠£Âú®ÊñΩÂ±ïÈ≠îÊ≥ï...
                                        </span>
                                    ) : '‚ú® ÁîüÊàêÈóúÂç°'}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Completion Modal */}
                    {completed && (
                        <div className="absolute inset-0 bg-black/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-3xl p-8 max-w-md w-full text-center shadow-2xl border-8 border-green-500 transform scale-100 animate-bounce-short">
                                <Trophy size={64} className="mx-auto text-yellow-500 mb-4" />
                                <h2 className="text-3xl font-black text-slate-800 mb-2">Â§™Ê£í‰∫ÜÔºÅ</h2>
                                <p className="text-slate-600 mb-4">‰Ω†ÊàêÂäüË£ùÈ£æ‰∫ÜËÅñË™ïÊ®πÔºÅ</p>
                                
                                {/* AI Generated Encouragement */}
                                {aiWinMessage ? (
                                    <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-6 animate-pulse">
                                        <p className="text-lg font-bold text-yellow-800">
                                            <span className="mr-2">ü§ñ AI ËÄÅÂ∏´Ë™™Ôºö</span>
                                            <br/>
                                            "{aiWinMessage}"
                                        </p>
                                    </div>
                                ) : (
                                    <div className="mb-6 h-16 flex items-center justify-center text-slate-400">
                                        <span className="animate-pulse">AI Ê≠£Âú®ÊÉ≥Ë™áÁçé‰Ω†ÁöÑË©±...</span>
                                    </div>
                                )}

                                <div className="flex justify-center">
                                    <button 
                                        onClick={startNewGame}
                                        className="bg-green-600 hover:bg-green-500 text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg transition-transform hover:scale-105 active:scale-95"
                                    >
                                        ÂÜç‰æÜ‰∏ÄÊ¨°
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Visual Feedback Overlay */}
                    {feedback && (
                        <div className="absolute top-20 pointer-events-none z-50 animate-ping">
                            {feedback === 'correct' ? (
                                <div className="text-green-400 text-4xl font-black drop-shadow-md">‚úì Ê≠£Á¢∫</div>
                            ) : (
                                <div className="text-red-500 text-4xl font-black drop-shadow-md">‚úï ÂÜçË©¶Ë©¶</div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MathTreeGame />);
    </script>
</body>
</html>